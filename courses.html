<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹åœ°åœ–</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .fixed-top {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            z-index: 1000;
        }
        body {
            margin: 0;
            padding: 0;
            padding-top: 52px; /* height of header + a bit of space */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #f5f5f5;
        }

        .course-node {
            fill: #f0f0f0;
            stroke: #999;
            stroke-width: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .course-node.unable {
            fill: #e0e0e0;
            stroke: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
            user-select: none;
        }

        .course-node.selected {
            fill: lightpink;
            stroke: black;
            stroke-width: 1px;
            user-select: none;
        }

        .course-node.placed {
            fill: #ffeaea !important;
            stroke: #ff0000 !important;
            stroke-width: 1.5px;
        }

        .course-text {
            font-size: 10px;
            pointer-events: none;
            dominant-baseline: middle;
            text-anchor: middle;
            user-select: none;
        }

        .course-text.unable {
            fill: #999;
            user-select: none;
        }

        .course-text-en {
            font-size: 10px;
            fill: #666;
            pointer-events: none;
            user-select: none;
        }

        .course-group {
            user-select: none;
        }

        .category-label {
            font-size: 12px;
            font-weight: bold;
            fill: #495057;
        }

        .dashboard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .selected-course-item {
            display: block;
            margin: 0;
            padding: 0;
            background: #f0f0f0;
            border-radius: 0;
            font-size: 12px;
            width: 100%;
            height: 100%;
            line-height: 20px;
            text-align: center;
            position: relative;
        }

        .remove-btn {
            position: absolute;
            right: 2px;
            top: 2px;
            width: 16px;
            height: 16px;
            background: #ff4444;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            line-height: 16px;
            cursor: pointer;
            z-index: 2;
            padding: 0;
        }

        .remove-btn:hover {
            background: #cc0000;
        }

        .category-container {
            fill: #f8f9fa;
            stroke: #dee2e6;
            stroke-width: 1px;
        }

        /* å¿…ä¿®æ·±ç° */
        .category-container.must {
            fill: #757575;
            stroke: #424242;
            stroke-width: 2px;
        }

        /* å¿…é¸ä¿®æ·ºè— */
        .category-container.elective {
            fill: #e3f2fd;
            stroke: #2196f3;
            stroke-width: 2px;
        }

        #clear-selection {
            margin: 5px;
            padding: 4px 8px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 12px;
        }

        #clear-selection:hover {
            background: #cc0000;
        }

        .credit-sum {
            font-size: 14px;
            margin-left: 10px;
            color: #495057;
        }

        .tooltip {
            position: absolute;
            padding: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 2px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            max-width: 200px;
            white-space: pre-line;
        }

        #course-map {
            margin-top: 60px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .module-connection {
            stroke: #666;
            stroke-width: 2;
            fill: none;
        }

        .module-arrow {
            fill: #666;
        }

        .grid-container {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .grid-cell {
            width: 150px;
            height: 20px;
            border: 1px dashed #ccc;
            margin: 2px;
            display: inline-block;
            vertical-align: top;
            position: relative;
        }

        .dragging {
            opacity: 0.5;
            cursor: move;
        }

        .grid-row {
            display: flex;
            justify-content: center;
            margin-bottom: 1px;
        }

        .course-clone {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
        }

        .remove-x-btn text {
            font-size: 13px;
            fill: #bdbdbd;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: fill 0.2s;
        }
        .remove-x-btn text:hover {
            fill: #e57373;
        }

        /* å¿…ä¿®ç™½å­— */
        .category-label.must {
            fill: #fff;
        }
        /* å¿…é¸ä¿®æ·±è—å­— */
        .category-label.elective {
            fill: #1976d2;
        }

        .must-course {
            fill: #757575 !important;
            stroke: #424242 !important;
        }
        .must-course-text {
            fill: #fff !important;
        }
        .elective-course {
            fill: #e3f2fd !important;
            stroke: #2196f3 !important;
        }
        .elective-course-text {
            fill: #1976d2 !important;
        }

        .placed {
            fill: #ffeaea !important;
            stroke: #ff0000 !important;
            stroke-width: 1.5px;
        }
        .placed-text {
            fill: #888 !important;
        }

        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .guidance-box {
            background: #e8f4fd;
            border: 2px solid #1976d2;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .guidance-title {
            color: #1976d2;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        .guidance-title::before {
            content: "ğŸ“‹";
            margin-right: 8px;
            font-size: 1.2rem;
        }
        .guidance-content {
            color: #333;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .guidance-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        .guidance-content li {
            margin-bottom: 8px;
        }
        .guidance-content strong {
            color: #d32f2f;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header class="fixed-top" style="background:#1976d2;color:#fff;padding:12px 0;text-align:center;font-size:1.2rem;letter-spacing:1px;cursor:pointer;width:100vw;">
        <a href="index.html" style="color:#fff;text-decoration:none;display:block;width:100%;height:100%;">NTU Journalism Services Portal</a>
    </header>
    
    <div class="guidance-box" style="margin-top: 60px;">
        <div class="guidance-title">ä¿®èª²æŒ‡å¼•</div>
        <div class="guidance-content">
            <ol>
                <li><strong>æè¨ˆåŠƒæ›¸å£è©¦å‰</strong>å¿…é ˆå®Œæˆå¿…ä¿®èˆ‡å¿…é¸ä¿®çš„èª²ç¨‹ï¼ŒåŒ…å«ç ”ç©¶æ–¹æ³•èˆ‡æ–°èå¯¦å‹™çš„å¿…é¸ä¿®è¦ç¯„ã€‚ä½†æ³¨æ„ï¼Œæ˜¯æè¨ˆåŠƒæ›¸å£è©¦å‰ï¼Œä¸¦éæ‰¾æŒ‡å°æ•™æˆå‰ã€‚</li>
                <li>æ‰¾æŒ‡å°æ•™æˆã€æè¨ˆåŠƒæ›¸å£è©¦ã€æœ€çµ‚è«–æ–‡å£è©¦éœ€è¦åˆ†åˆ¥é–“éš”<strong>ä¸‰å€‹æœˆ</strong>ã€‚</li>
            </ol>
        </div>
    </div>
    
    <div id="svg-container" style="width: 1200px; margin: 0 auto; display: block;">
        <svg id="main-svg"></svg>
    </div>

    <script>
        const width = 1200;
        const height = 1000;
        const svg = d3.select('#course-map')
            .attr('width', width)
            .attr('height', height);

        const margin = {top: 80, right: 20, bottom: 20, left: 20};

        let selectedCourses = new Set();
        let courseData = null;

        const tooltip = d3.select('body').append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);

        // å®šç¾©é€£æ¥ç·šçš„èµ·é»å’Œçµ‚é»
        const connections = [
            // æ ¸å¿ƒé¸ä¿®åˆ°ä¸‰å€‹å¿…é¸ä¿®æ¨¡çµ„
            {from: 'æ ¸å¿ƒé¸ä¿®', to: 'å¿…ä¿®'},
            {from: 'æ ¸å¿ƒé¸ä¿®', to: 'å¿…é¸ä¿®-å¯¦å‹™'},
            {from: 'æ ¸å¿ƒé¸ä¿®', to: 'å¿…é¸ä¿®-æ–¹æ³•'},
            // å¿…é¸ä¿®æ¨¡çµ„åˆ°å»¶ä¼¸é¸ä¿®
            {from: 'å¿…ä¿®', to: 'å»¶ä¼¸é¸ä¿®'},
            {from: 'å¿…é¸ä¿®-å¯¦å‹™', to: 'å»¶ä¼¸é¸ä¿®'},
            {from: 'å¿…é¸ä¿®-æ–¹æ³•', to: 'å»¶ä¼¸é¸ä¿®'}
        ];

        // é‡æ–°è¨­è¨ˆçš„æ¨¡çµ„å¸ƒå±€
        const categoryLayout = {
            'æ ¸å¿ƒé¸ä¿®': { x: width/2 - 80, y: 50, width: 160, height: 30, isCore: true },
        };
        // å¿…ä¿®/å¿…é¸ä¿®å€å¡Š y = æ ¸å¿ƒé¸ä¿®åº•éƒ¨ + 20px
        const coreBottomY = categoryLayout['æ ¸å¿ƒé¸ä¿®'].y + categoryLayout['æ ¸å¿ƒé¸ä¿®'].height;
        categoryLayout['å¿…ä¿®'] = { x: width/2 - 240, y: coreBottomY + 20, width: 160, height: 150 };
        categoryLayout['å¿…é¸ä¿®-å¯¦å‹™'] = { x: width/2 - 80, y: coreBottomY + 20, width: 160, height: 150 };
        categoryLayout['å¿…é¸ä¿®-æ–¹æ³•'] = { x: width/2 + 80, y: coreBottomY + 20, width: 160, height: 150 };
        // è¨ˆç®—å¿…ä¿®ç¾¤åº•éƒ¨æœ€å¤§å€¼
        const mustBlockBottom = Math.max(
            categoryLayout['å¿…ä¿®'].y + categoryLayout['å¿…ä¿®'].height,
            categoryLayout['å¿…é¸ä¿®-å¯¦å‹™'].y + categoryLayout['å¿…é¸ä¿®-å¯¦å‹™'].height,
            categoryLayout['å¿…é¸ä¿®-æ–¹æ³•'].y + categoryLayout['å¿…é¸ä¿®-æ–¹æ³•'].height
        );
        categoryLayout['å»¶ä¼¸é¸ä¿®'] = { x: width/2 - 80, y: mustBlockBottom + 20, width: 160, height: 30, isCore: true };
        categoryLayout['ç•¢æ¥­è«–æ–‡'] = { x: width/2 - 80, y: 850, width: 160, height: 100, isCore: true };

        // è¨ˆç®—æœ€å¤§å€å¡Šé«˜åº¦
        const maxHeight = Math.max(300, 200, 250, 250, 300); // ä½ å¯æ ¹æ“šå¯¦éš›éœ€æ±‚èª¿æ•´

        d3.csv('data/courses.csv').then(data => {
            courseData = data;
            
            const categories = Object.keys(categoryLayout);
            
            // ====== ç•«ä¸‹åŠéƒ¨èª²ç¨‹åœ°åœ–ï¼ˆå…¨éƒ¨ç”¨ mainSvgï¼Œy åº§æ¨™åŠ  courseMapOffsetYï¼‰ ======
            // ç¹ªè£½é€£æ¥ç·š
            connections.forEach(conn => {
                const from = categoryLayout[conn.from];
                const to = categoryLayout[conn.to];
                const startX = from.x + from.width/2;
                const startY = from.y + from.height + courseMapOffsetY;
                const endX = to.x + to.width/2;
                const endY = to.y + courseMapOffsetY;
                mainSvg.append('path')
                    .attr('class', 'module-connection')
                    .attr('d', `M ${startX} ${startY} \
                              L ${startX} ${(startY + endY)/2}
                              L ${endX} ${(startY + endY)/2}
                              L ${endX} ${endY}`);
                mainSvg.append('path')
                    .attr('class', 'module-arrow')
                    .attr('d', `M ${endX-5} ${endY-5} L ${endX} ${endY} L ${endX+5} ${endY-5}`);
            });

            // ç¹ªè£½æ¨¡çµ„å®¹å™¨
            mainSvg.selectAll('.category-container')
                .data(categories)
                .enter()
                .append('rect')
                .attr('class', 'category-container')
                .attr('x', d => categoryLayout[d].x)
                .attr('y', d => categoryLayout[d].y + courseMapOffsetY)
                .attr('width', d => categoryLayout[d].width)
                .attr('height', d => categoryLayout[d].height);

            // ç¹ªè£½æ¨¡çµ„æ¨™ç±¤
            mainSvg.selectAll('.category-label')
                .data(categories)
                .enter()
                .append('text')
                .attr('class', d => {
                    if (d === 'å¿…ä¿®') return 'category-label must';
                    if (d.startsWith('å¿…é¸ä¿®')) return 'category-label elective';
                    return 'category-label';
                })
                .attr('x', d => categoryLayout[d].x + categoryLayout[d].width/2)
                .attr('y', d => categoryLayout[d].y + (categoryLayout[d].isCore ? 20 : 15) + courseMapOffsetY)
                .attr('text-anchor', 'middle')
                .text(d => d);

            // åœ¨ç•¢æ¥­è«–æ–‡æ–¹å¡Šä¸­æ·»åŠ å­é …ç›®
            if (categoryLayout['ç•¢æ¥­è«–æ–‡']) {
                const thesisBox = categoryLayout['ç•¢æ¥­è«–æ–‡'];
                const thesisItems = ['å°ˆæ¥­å ±å°', '(å¹³é¢/å½±åƒ/å¤šåª’é«”)', 'å­¸è¡“è«–æ–‡'];
                thesisItems.forEach((item, i) => {
                    mainSvg.append('text')
                        .attr('class', 'course-text')
                        .attr('x', thesisBox.x + thesisBox.width/2)
                        .attr('y', thesisBox.y + 35 + (i * 15) + courseMapOffsetY)
                        .attr('text-anchor', 'middle')
                        .text(item);
                });
            }

            // ä¸‹æ–¹äº”å€‹å€å¡Šç”¨ <g> ç¾¤çµ„åŒ…è£¹ä¸¦ç½®ä¸­
            const blockWidth = 160;
            const blockHeight = Math.max(300, 200, 250, 250, 300);
            const blockGap = 0;
            const totalWidth = blockWidth * 5 + blockGap * 4;
            const startX = (width - totalWidth) / 2;
            const extendY = categoryLayout['å»¶ä¼¸é¸ä¿®'].y + categoryLayout['å»¶ä¼¸é¸ä¿®'].height + 20;
            const bottomBlocks = [
              { key: 'ç†è«–/æ–¹æ³•', label: 'ç†è«–/æ–¹æ³•' },
              { key: 'åª’é«”å…¬æ°‘æ„è­˜', label: 'åª’é«”å…¬æ°‘æ„è­˜' },
              { key: 'åœ‹éš›è¦–é‡', label: 'åœ‹éš›è¦–é‡' },
              { key: 'æ•¸ä½çŸ¥èƒ½', label: 'æ•¸ä½çŸ¥èƒ½' },
              { key: 'å°ˆæ¥­å¯¦ä½œ', label: 'å°ˆæ¥­å¯¦ä½œ' }
            ];
            const bottomBlockKeys = bottomBlocks.map(b => b.key);
            const bottomGroup = mainSvg.append('g')
              .attr('id', 'bottom-blocks-group')
              .attr('transform', `translate(${startX},${extendY + courseMapOffsetY})`);
            // ç•«äº”å€‹åº•ä¸‹å€å¡Šçš„å¤–æ¡†å’Œæ¨™é¡Œ
            bottomBlocks.forEach((block, i) => {
              bottomGroup.append('rect')
                .attr('x', i * (blockWidth + blockGap))
                .attr('y', 0)
                .attr('width', blockWidth)
                .attr('height', blockHeight)
                .attr('class', 'category-container');
              bottomGroup.append('text')
                .attr('x', i * (blockWidth + blockGap) + blockWidth / 2)
                .attr('y', 20)
                .attr('text-anchor', 'middle')
                .attr('class', 'category-label')
                .text(block.label);
            });

            // å…ˆç•«ä¸Šå±¤å€å¡Šçš„èª²ç¨‹ï¼ˆç•«åœ¨ mainSvg çš„ä¸‹æ–¹ï¼‰
            data.forEach((course, i) => {
              const category = course.category;
              if (bottomBlockKeys.includes(category)) {
                return;
              }
              const layout = categoryLayout[category];
              const coursesInCategory = data.filter(d => d.category === category)
                .sort((a, b) => {
                  if (a.active === 'unable' && b.active !== 'unable') return 1;
                  if (a.active !== 'unable' && b.active === 'unable') return -1;
                  return 0;
                });
              const index = coursesInCategory.indexOf(course);
              course.x = layout.x + 5;
              course.y = layout.y + 25 + (index * 21) + courseMapOffsetY; // 21px: 20pxé«˜åº¦+1pxé–“è·
              // åˆ¤æ–·èª²ç¨‹é¡è‰² class
              let rectClass = `course-node ${course.active === 'unable' ? 'unable' : ''}`;
              let textClass = `course-text ${course.active === 'unable' ? 'unable' : ''}`;
              if (category === 'å¿…ä¿®') {
                rectClass += ' must-course';
                textClass += ' must-course-text';
              } else if (category.startsWith('å¿…é¸ä¿®')) {
                rectClass += ' elective-course';
                textClass += ' elective-course-text';
              }
              // ç•«åœ¨ mainSvg ä¸‹æ–¹
              const group = mainSvg.append('g')
                .attr('class', 'course-group')
                .attr('transform', `translate(${course.x}, ${course.y})`)
                .datum(course);
              group.append('rect')
                .attr('class', rectClass)
                .attr('width', 150)
                .attr('height', 20)
                .attr('rx', 0);
              group.append('text')
                .attr('class', textClass)
                .attr('x', 75)
                .attr('y', 10)
                .text(course.cname);
            });

            // å†ç•«ä¸‹æ–¹äº”å€‹å€å¡Šçš„èª²ç¨‹
            bottomBlocks.forEach((block, blockIndex) => {
              const coursesInCategory = data.filter(d => d.category === block.key)
                .sort((a, b) => {
                  if (a.active === 'unable' && b.active !== 'unable') return 1;
                  if (a.active !== 'unable' && b.active === 'unable') return -1;
                  return 0;
                });
              coursesInCategory.forEach((course, i) => {
                // åˆ¤æ–·èª²ç¨‹é¡è‰² class
                let rectClass = `course-node ${course.active === 'unable' ? 'unable' : ''}`;
                let textClass = `course-text ${course.active === 'unable' ? 'unable' : ''}`;
                if (block.key === 'å¿…ä¿®') {
                  rectClass += ' must-course';
                  textClass += ' must-course-text';
                } else if (block.key.startsWith('å¿…é¸ä¿®')) {
                  rectClass += ' elective-course';
                  textClass += ' elective-course-text';
                }
                const group = bottomGroup.append('g')
                  .attr('class', 'course-group')
                  .attr('transform', `translate(${blockIndex * (blockWidth + blockGap) + 5}, ${30 + i * 21})`)
                  .datum(course);
                group.append('rect')
                  .attr('class', rectClass)
                  .attr('width', 150)
                  .attr('height', 20)
                  .attr('rx', 0);
                group.append('text')
                  .attr('class', textClass)
                  .attr('x', 75)
                  .attr('y', 10)
                  .text(course.cname);
              });
            });

            // å•Ÿç”¨ mainSvg å…§æ‰€æœ‰ä¸‹æ–¹èª²ç¨‹æ‹–æ‹‰åˆ°ä¸Šæ–¹æ ¼å­ï¼ˆåŒ…å«äº”å¤§æ¨¡çµ„å€ï¼‰
            function enableAllCourseDrag() {
                // å…ˆæ”¶é›†æ‰€æœ‰ grid cell ä¸Šçš„ groupï¼ˆä¸Šæ–¹5x5æ ¼å­çš„èª²ç¨‹ï¼‰
                const gridCellGroups = new Set();
                gridCells.forEach(cell => {
                    if (cell.course) gridCellGroups.add(cell.course.node());
                });
                mainSvg.selectAll('.course-group').each(function(d) {
                    const g = d3.select(this);
                    const course = g.datum();
                    // è·³éä¸Šæ–¹æ ¼å­çš„ group
                    if (gridCellGroups.has(this)) return;
                    g.on('mousedown', function(event) {
                        if (course.active === 'unable') return;
                        draggingCourseData = course;
                        draggingSource = 'main';
                        dragVisual = mainSvg.append('g')
                            .attr('pointer-events', 'none')
                            .attr('opacity', 0.7);
                        dragVisual.append('rect')
                            .attr('width', gridCellSize.width)
                            .attr('height', gridCellSize.height)
                            .attr('fill', '#f0f0f0')
                            .attr('stroke', '#999');
                        dragVisual.append('text')
                            .attr('x', gridCellSize.width/2)
                            .attr('y', gridCellSize.height/2 + 1)
                            .attr('text-anchor', 'middle')
                            .attr('dominant-baseline', 'middle')
                            .attr('font-size', 12)
                            .text(course.cname);
                        document.addEventListener('mousemove', handleGridMouseMove);
                        document.addEventListener('mouseup', handleGridMouseUp);
                    });
                });
            }
            enableAllCourseDrag();
        });

        function updateDashboard() {
            const selectedCount = selectedCourses.size;
            const creditSum = Array.from(selectedCourses).reduce((sum, course) => sum + parseInt(course.credit || 0), 0);
            
            d3.select('#selected-count').text(selectedCount);
            d3.select('#credit-sum').text(creditSum);
            
            const selectedCoursesDiv = d3.select('#selected-courses');
            selectedCoursesDiv.html('');
            
            selectedCourses.forEach(course => {
                selectedCoursesDiv.append('div')
                    .attr('class', 'selected-course-item')
                    .text(`${course.cname} (${course.credit}å­¸åˆ†)`);
            });
        }

        // ====== æ–°å¢ï¼šSVG 5x5 æ ¼å­å€ ======
        const gridCellSize = { width: 150, height: 20, gap: 2 };
        const gridRows = 5, gridCols = 5;
        const gridSvgWidth = 1200;
        const gridSvgHeight = gridRows * (gridCellSize.height + gridCellSize.gap) + gridCellSize.gap;
        const courseMapOffsetY = gridSvgHeight; // ä¸‹æ–¹èª²ç¨‹åœ°åœ–çš„ Y åç§»ï¼ˆæ¥µçª„ï¼‰
        const mainSvgHeight = courseMapOffsetY + 1000; // èª²ç¨‹åœ°åœ–é«˜åº¦
        const mainSvg = d3.select('#main-svg')
            .attr('width', gridSvgWidth)
            .attr('height', mainSvgHeight)
            .style('display', 'block')
            .style('margin', '40px auto 10px auto')
            .style('background', 'white');

        // Grid top labels and grid cells
        const gridTopLabels = ['ç¢©ä¸€ä¸Š', 'ç¢©ä¸€ä¸‹', 'ç¢©äºŒä¸Š', 'ç¢©äºŒä¸‹', 'ç¢©ä¸‰ä¸Š'];
        const totalGridWidth = gridCols * gridCellSize.width + (gridCols - 1) * gridCellSize.gap;
        const startX = (gridSvgWidth - totalGridWidth) / 2;
        const gridCells = [];
        // Top row labels
        for (let col = 0; col < gridCols; col++) {
            mainSvg.append('text')
                .attr('x', startX + col * (gridCellSize.width + gridCellSize.gap) + gridCellSize.width / 2)
                .attr('y', 18)
                .attr('text-anchor', 'middle')
                .attr('font-size', 15)
                .attr('fill', '#888')
                .attr('font-weight', 'bold')
                .text(gridTopLabels[col]);
        }
        // Draw grid cells
        for (let row = 0; row < gridRows; row++) {
            for (let col = 0; col < gridCols; col++) {
                const x = startX + col * (gridCellSize.width + gridCellSize.gap);
                const y = gridCellSize.gap + row * (gridCellSize.height + gridCellSize.gap);
                gridCells.push({ row, col, x, y, course: null });
                mainSvg.append('rect')
                    .attr('x', x)
                    .attr('y', y)
                    .attr('width', gridCellSize.width)
                    .attr('height', gridCellSize.height)
                    .attr('fill', 'none')
                    .attr('stroke', '#ccc')
                    .attr('stroke-dasharray', '4,2');
            }
        }

        // æ‹–æ‹‰ç‹€æ…‹
        let draggingCourseData = null;
        let draggingSource = null; // 'main' or {row, col}
        let dragVisual = null;

        // å¹«åŠ©å‡½æ•¸ï¼šæ ¹æ“šèª²ç¨‹è³‡æ–™ç”¢ç”ŸSVG group
        function createCourseGroup(course, x, y, isGrid, gridRow, gridCol) {
            const group = mainSvg.append('g')
                .attr('class', 'course-group')
                .attr('transform', `translate(${x},${y})`)
                .datum(course);
            // åˆ¤æ–·èª²ç¨‹é¡è‰² class
            let rectClass = `course-node${course.active === 'unable' ? ' unable' : ''}`;
            let textClass = `course-text${course.active === 'unable' ? ' unable' : ''}`;
            if (course.category === 'å¿…ä¿®') {
                rectClass += ' must-course';
                textClass += ' must-course-text';
            } else if (course.category && course.category.startsWith('å¿…é¸ä¿®')) {
                rectClass += ' elective-course';
                textClass += ' elective-course-text';
            }
            group.append('rect')
                .attr('class', rectClass)
                .attr('width', gridCellSize.width)
                .attr('height', gridCellSize.height)
                .attr('rx', 0);
            group.append('text')
                .attr('class', textClass)
                .attr('x', gridCellSize.width/2)
                .attr('y', gridCellSize.height/2 + 1)
                .text(course.cname);

            // X æŒ‰éˆ• (å³ä¸Šè§’)
            if (isGrid) {
                const xBtn = group.append('g')
                    .attr('class', 'remove-x-btn')
                    .style('cursor', 'pointer');
                xBtn.append('text')
                    .attr('x', gridCellSize.width - 10)
                    .attr('y', 13)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', 13)
                    .attr('fill', '#bdbdbd')
                    .attr('font-weight', 'bold')
                    .text('Ã—');
                xBtn.on('mousedown', function(event) {
                    event.stopPropagation();
                    group.remove();
                    // æ¸…ç©ºæ ¼å­è¨˜éŒ„
                    if (typeof gridRow === 'number' && typeof gridCol === 'number') {
                        const idx = gridRow * gridCols + gridCol;
                        gridCells[idx].course = null;
                    }
                    updatePlacedState();
                });
            }

            // hover tooltipï¼ˆåªåœ¨ä¸‹æ–¹èª²ç¨‹åœ°åœ–å€å¡Šå•Ÿç”¨ï¼‰
            if (!isGrid) {
                group.on('mouseover', function(event) {
                    if (course.active === 'unable') return;
                    const tooltipText = `èª²ç¨‹åç¨±ï¼š${course.cname}\nè‹±æ–‡åç¨±ï¼š${course.cname_en}\nå­¸åˆ†æ•¸ï¼š${course.credit}\næˆèª²æ•™å¸«ï¼š${course.offer_by || 'å¾…è˜'}\nå»ºè­°ä¿®èª²ï¼š${course.suggest || 'ä¸é™'}`;
                    tooltip.transition().duration(200).style('opacity', .9);
                    tooltip.html(tooltipText)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition().duration(500).style('opacity', 0);
                });
            }

            // æ‹–æ‹‰
            group.on('mousedown', function(event) {
                if (course.active === 'unable') return;
                draggingCourseData = course;
                draggingSource = isGrid ? {row: gridRow, col: gridCol} : 'main';
                dragVisual = mainSvg.append('g')
                    .attr('pointer-events', 'none')
                    .attr('opacity', 0.7);
                dragVisual.append('rect')
                    .attr('width', gridCellSize.width)
                    .attr('height', gridCellSize.height)
                    .attr('fill', '#f0f0f0')
                    .attr('stroke', '#999');
                dragVisual.append('text')
                    .attr('x', gridCellSize.width/2)
                    .attr('y', gridCellSize.height/2 + 1)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('font-size', 12)
                    .text(course.cname);
                document.addEventListener('mousemove', handleGridMouseMove);
                document.addEventListener('mouseup', handleGridMouseUp);
            });
            return group;
        }

        function handleGridMouseMove(event) {
            if (!dragVisual) return;
            // è®“æ‹–æ›³è¦–è¦ºè·Ÿéš¨æ»‘é¼ 
            const svgRect = mainSvg.node().getBoundingClientRect();
            dragVisual.attr('transform', `translate(${event.clientX - svgRect.left - gridCellSize.width/2},${event.clientY - svgRect.top - gridCellSize.height/2})`);
        }

        function handleGridMouseUp(event) {
            if (!dragVisual) return;
            const svgRect = mainSvg.node().getBoundingClientRect();
            let dropped = false;
            for (let i = 0; i < gridCells.length; i++) {
                const cell = gridCells[i];
                const cx = cell.x, cy = cell.y;
                if (event.clientX >= svgRect.left + cx && event.clientX <= svgRect.left + cx + gridCellSize.width &&
                    event.clientY >= svgRect.top + cy && event.clientY <= svgRect.top + cy + gridCellSize.height) {
                    // ä¸å…è¨±åŒä¸€èª²ç¨‹å¤šæ¬¡å‡ºç¾
                    const alreadyPlaced = gridCells.some(c => c.course && c.course.datum().cname === draggingCourseData.cname);
                    if (alreadyPlaced && (draggingSource === 'main' || (draggingSource.row !== cell.row || draggingSource.col !== cell.col))) {
                        break;
                    }
                    // ç§»é™¤åŸæœ¬æ ¼å­çš„èª²ç¨‹
                    if (cell.course) cell.course.remove();
                    // å¦‚æœä¾†æºæ˜¯æ ¼å­ï¼Œæ¸…ç©ºä¾†æºæ ¼å­
                    if (draggingSource !== 'main' && draggingSource.row !== undefined) {
                        const srcIdx = draggingSource.row * gridCols + draggingSource.col;
                        if (gridCells[srcIdx].course) gridCells[srcIdx].course.remove();
                        gridCells[srcIdx].course = null;
                    }
                    // è¤‡è£½ä¸€ä»½ group åˆ°æ ¼å­
                    cell.course = createCourseGroup(draggingCourseData, cell.x, cell.y, true, cell.row, cell.col);
                    updatePlacedState();
                    dropped = true;
                    break;
                }
            }
            dragVisual.remove();
            dragVisual = null;
            draggingCourseData = null;
            draggingSource = null;
            document.removeEventListener('mousemove', handleGridMouseMove);
            document.removeEventListener('mouseup', handleGridMouseUp);
            updatePlacedState();
        }

        // åªå°ä¸‹æ–¹èª²ç¨‹æ–¹å¡ŠåŠ  placed æ¨£å¼ï¼Œä¸Šæ–¹ grid cell ä¿æŒåŸè‰²
        function updatePlacedState() {
            // å–å¾—æ‰€æœ‰æ ¼å­è£¡çš„èª²ç¨‹åç¨±
            const placedNames = gridCells.filter(cell => cell.course)
                .map(cell => cell.course ? cell.course.datum().cname : null)
                .filter(Boolean);
            // æ”¶é›†æ‰€æœ‰ grid cell ä¸Šçš„ group
            const gridCellGroups = new Set();
            gridCells.forEach(cell => {
                if (cell.course) gridCellGroups.add(cell.course.node());
            });
            mainSvg.selectAll('.course-group').each(function(d) {
                const g = d3.select(this);
                // è·³éä¸Šæ–¹æ ¼å­çš„ group
                if (gridCellGroups.has(this)) return;
                g.select('.course-node').classed('placed', placedNames.includes(d.cname));
                g.select('text').classed('placed-text', placedNames.includes(d.cname));
            });
        }

        // ====== END SVG 5x5 æ ¼å­å€ ======
    </script>
</body>
</html> 