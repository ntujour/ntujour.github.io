<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Google Sheet CSV 讀取展示</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    table {
      border-collapse: collapse;
      margin: 20px;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 4px 8px; 
    }
    th {
      background: #f0f0f0;
    }
    h3 {
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .student-badge {
      display: inline-block;
      background: #e3f2fd;
      color: #1565c0;
      border-radius: 6px;
      padding: 2px 4px;
      margin: 2px 2px 2px 0;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid #90caf9;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }
    .student-badge.research {
      background: #ede7f6;
      color: #5e35b1;
      border: 1px solid #b39ddb;
    }
    .student-badge:hover {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }
    .student-badge.research:hover {
      background: #7e57c2;
      color: #fff;
      border-color: #7e57c2;
    }
    .advisor-section {
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 10px 10px 10px 10px;
      margin-bottom: 12px;
      background: #fafbfc;
    }
  </style>
</head>
<body>
  <h2>學生指導紀錄</h2>
  <div id="sheet-table"></div>
  <script>
    d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vTofwdyqFHIOiQtKMvnTN3wd138UG2ZL8LtrCWUyA6Rpl0NUZViTjllXf1pZ-i4d85dIOL3S5aobVzN/pub?gid=0&single=true&output=csv')
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById('sheet-table').innerText = '無資料';
          return;
        }

        // 依指導老師分組（支援多位老師）
        const advisorMap = {};
        data.forEach(row => {
          const advisorField = row['指導老師']?.trim();
          const student = row['學生姓名']?.trim();
          if (!advisorField || !student) return;
          // 支援「、」或「,」分隔
          const advisors = advisorField.split(/、|,|，/).map(name => name.trim()).filter(Boolean);
          advisors.forEach(advisor => {
            if (!advisorMap[advisor]) advisorMap[advisor] = { students: [] };
            advisorMap[advisor].students.push(row);
          });
        });

        // 產生顯示區塊
        const container = document.getElementById('sheet-table');
        container.innerHTML = '';

        // 專任老師順序
        const fulltimeAdvisors = ['林麗雲', '洪貞玲', '林照真', '謝吉隆', '劉好迪', '蔡蕙如'];
        // 兼任老師順序
        const adjunctAdvisors = ['李志德', '梁玉芳', '王泰俐', '鄭凱駿', '黃哲斌', '李雪莉', '黃兆徽'];
        // 狀態順序
        const statusOrder = ['在學中', '簽指導', '計畫書', '休學中', '交換中', '已畢業'];

        // 只顯示專任老師
        fulltimeAdvisors.forEach(advisor => {
          if (!advisorMap[advisor]) return;
          renderAdvisorSection(advisor, advisorMap[advisor].students);
        });

        // 只顯示指定兼任老師
        adjunctAdvisors.forEach(advisor => {
          if (!advisorMap[advisor]) return;
          renderAdvisorSection(advisor, advisorMap[advisor].students);
        });

        // 渲染單一老師區塊的函式
        function renderAdvisorSection(advisor, students) {
          const section = document.createElement('div');
          section.className = 'advisor-section';

          // 老師名字
          const h3 = document.createElement('h3');
          h3.textContent = advisor;
          section.appendChild(h3);

          // 用 ul/li 分開
          const ul = document.createElement('ul');
          ul.style.listStyle = 'none';
          ul.style.padding = '0';
          ul.style.margin = '0';

          // 依畢業狀態分群
          const statusMap = {};
          students.forEach(row => {
            const status = (row['畢業狀態更新'] || '未填寫').trim();
            if (!statusMap[status]) statusMap[status] = [];
            statusMap[status].push(row);
          });

          // 依指定狀態順序顯示
          statusOrder.forEach(status => {
            if (!statusMap[status]) return;
            const li = document.createElement('li');
            li.style.marginBottom = '4px';
            const label = document.createElement('span');
            label.textContent = status + '：';
            li.appendChild(label);

            statusMap[status].forEach(row => {
              const badge = document.createElement('span');
              if ((row['論文類型'] || '').trim() === '研究組') {
                badge.className = 'student-badge research';
              } else {
                badge.className = 'student-badge';
              }
              badge.textContent = `(${row['屆次']})${row['學生姓名']}`;
              badge.onmouseover = e => showTooltip(e, row);
              badge.onmouseout = hideTooltip;
              li.appendChild(badge);
            });
            ul.appendChild(li);
          });

          section.appendChild(ul);
          container.appendChild(section);
        }

        // 浮動選單
        let tooltip = document.getElementById('advisee-tooltip');
        if (!tooltip) {
          tooltip = document.createElement('div');
          tooltip.id = 'advisee-tooltip';
          tooltip.style.position = 'absolute';
          tooltip.style.background = 'rgba(0,0,0,0.85)';
          tooltip.style.color = 'white';
          tooltip.style.padding = '8px 12px';
          tooltip.style.borderRadius = '4px';
          tooltip.style.fontSize = '14px';
          tooltip.style.pointerEvents = 'none';
          tooltip.style.display = 'none';
          tooltip.style.zIndex = 1000;
          document.body.appendChild(tooltip);
        }

        function showTooltip(e, row) {
          tooltip.innerHTML = Object.entries(row)
            .map(([k, v]) => `<b>${k}</b>：${v}`)
            .join('<br>');
          tooltip.style.display = 'block';
          tooltip.style.left = (e.pageX + 10) + 'px';
          tooltip.style.top = (e.pageY + 10) + 'px';
        }
        function hideTooltip() {
          tooltip.style.display = 'none';
        }
      })
      .catch(err => {
        document.getElementById('sheet-table').innerText = '讀取失敗：' + err;
      });
  </script>
</body>
</html>
